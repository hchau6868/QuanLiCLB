<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billiards Manager Pro - Online Sync</title>
    
    <!-- 1. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 4. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <!-- C·∫•u h√¨nh Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Orbitron', 'sans-serif'],
                    },
                    colors: {
                        neon: {
                            green: '#39ff14',
                            blue: '#00f3ff',
                            purple: '#d946ef',
                            red: '#ff003c'
                        },
                        gold: '#ffd700',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-in': 'slideIn 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        
        /* Dark Mode */
        .dark body { background-color: #111827; color: #e4e4e7; }
        .dark .glass-panel { background: rgba(31, 41, 55, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .dark .glow-active { box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); border-color: #39ff14 !important; }

        /* Light Mode */
        body { background-color: #f3f4f6; color: #1f2937; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(0, 0, 0, 0.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .glow-active { box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); border-color: #10b981 !important; }

        /* Login Screen */
        .login-bg { background-image: radial-gradient(circle at 50% 50%, #1f2937 0%, #111827 100%); z-index: 100; }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            min-width: 300px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
<script type="importmap">
{
  "imports": {
    "lucide-react": "https://esm.sh/lucide-react@^0.564.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "react": "https://esm.sh/react@^19.2.4",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <!-- SOUND EFFECT (Hidden) -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center login-bg">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl relative">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-neon-green/10 text-neon-green border border-neon-green/30 mb-4 shadow-[0_0_15px_rgba(57,255,20,0.3)]">
                    <i class="fa-solid fa-cloud text-3xl"></i>
                </div>
                <h1 class="text-3xl font-display font-bold text-white tracking-wide">
                    BILLIARDS <span class="text-neon-green">ONLINE</span>
                </h1>
                <p class="text-gray-400 text-sm mt-2">ƒê·ªìng b·ªô d·ªØ li·ªáu Realtime</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">T√†i kho·∫£n</label>
                    <input type="text" id="username" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg py-3 px-4 text-white focus:outline-none focus:border-neon-green transition-all" placeholder="T√™n T√†i Kho·∫£n">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg py-3 px-4 text-white focus:outline-none focus:border-neon-green transition-all" placeholder="M·∫≠t Kh·∫©u">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden font-bold">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> Sai th√¥ng tin ƒëƒÉng nh·∫≠p!
                </div>
                <button type="submit" class="w-full bg-neon-green hover:bg-green-400 text-black font-bold py-3 rounded-lg shadow-[0_0_15px_rgba(57,255,20,0.4)] transition-transform hover:scale-[1.02]">
                    K·∫æT N·ªêI SERVER
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="min-h-screen pb-10 transition-colors duration-300 hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 glass-panel border-b border-gray-200 dark:border-gray-700 shadow-lg mb-8">
            <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="p-2 bg-gradient-to-br from-green-500 to-green-700 dark:from-neon-green dark:to-green-700 rounded-lg shadow-lg">
                        <i class="fa-solid fa-layer-group text-white dark:text-black text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-display font-bold text-gray-900 dark:text-white tracking-wide">
                            BILLIARDS <span class="text-green-600 dark:text-neon-green">PRO</span>
                        </h1>
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <p class="text-[10px] text-green-600 dark:text-green-400 font-bold uppercase tracking-wider">Online Sync</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 md:gap-8">
                    <div class="hidden md:block text-right">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">ƒê∆°n gi√° (Block)</p>
                        <p class="text-xl font-bold text-yellow-600 dark:text-gold font-display">10k<span class="text-xs text-gray-500 font-sans ml-1">/15p</span></p>
                    </div>
                    
                    <button id="settings-btn" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700 flex items-center justify-center transition-colors shadow-sm border border-gray-300 dark:border-gray-600 cursor-pointer">
                        <i class="fa-solid fa-gear text-lg animate-[spin_10s_linear_infinite]"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 space-y-10">
            <!-- Table List -->
            <section>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-1 h-8 bg-green-500 dark:bg-neon-green rounded-full shadow-lg"></div>
                    <h2 class="text-xl text-gray-900 dark:text-white font-bold">Danh s√°ch b√†n (Realtime)</h2>
                </div>
                <!-- Loading State -->
                <div id="loading-tables" class="text-center py-10 text-gray-500 animate-pulse">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß...</p>
                </div>
                <div id="table-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                    <!-- Tables injected via JS -->
                </div>
            </section>

            <!-- Stats -->
            <section>
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-1 h-8 bg-blue-500 dark:bg-neon-blue rounded-full shadow-lg"></div>
                    <h2 class="text-xl text-gray-900 dark:text-white font-bold">Doanh thu h√¥m nay</h2>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 glass-panel rounded-xl p-6 border border-gray-200 dark:border-gray-700 flex flex-col">
                        <h3 class="text-lg font-display font-bold text-gray-800 dark:text-white mb-6">T·ªïng quan</h3>
                        <div class="mb-8">
                            <p class="text-gray-500 dark:text-gray-400 text-sm mb-1 uppercase tracking-wider">T·ªïng thu</p>
                            <p id="total-revenue-display" class="text-4xl font-bold text-yellow-600 dark:text-gold font-display drop-shadow-md">0 ‚Ç´</p>
                        </div>
                        <div class="flex-1 w-full min-h-[200px] relative">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="lg:col-span-2 glass-panel rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col h-[500px]">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center">
                            <h3 class="text-lg font-display font-bold text-gray-800 dark:text-white">L·ªãch s·ª≠ giao d·ªãch</h3>
                            <span id="history-count" class="text-xs text-gray-500 bg-gray-200 dark:bg-gray-900 px-2 py-1 rounded">0 GD</span>
                        </div>
                        <div class="overflow-y-auto p-0 flex-1">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 sticky top-0 z-10 shadow-md">
                                    <tr>
                                        <th class="p-4 text-xs uppercase">B√†n</th>
                                        <th class="p-4 text-xs uppercase">Gi·ªù ra</th>
                                        <th class="p-4 text-xs uppercase text-right">T·ªïng ti·ªÅn</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="divide-y divide-gray-200 dark:divide-gray-700/50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <!-- 1. Service Modal -->
    <div id="service-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">G·ªçi M√≥n <span id="service-modal-table-id" class="text-blue-500 ml-2"></span></h2>
                <button onclick="app.closeModal('service-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="menu-grid" class="p-5 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 dark:bg-gray-900/50"></div>
            <div class="p-5 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <button onclick="app.closeModal('service-modal')" class="w-full py-3 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white uppercase">Xong</button>
            </div>
        </div>
    </div>

    <!-- 2. Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl w-full max-w-md shadow-2xl">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2"><i class="fa-solid fa-receipt text-yellow-500"></i> Thanh To√°n</h2>
                <button onclick="app.closeModal('checkout-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="checkout-content" class="p-6 space-y-5 bg-white dark:bg-gray-800"></div>
            <div class="p-5 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex gap-3">
                <button onclick="app.closeModal('checkout-modal')" class="flex-1 py-3 rounded-lg font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">H·ªßy</button>
                <button onclick="app.confirmCheckout()" class="flex-1 py-3 rounded-lg font-bold bg-yellow-400 hover:bg-yellow-500 text-black shadow-lg"><i class="fa-solid fa-print"></i> Thanh to√°n</button>
            </div>
        </div>
    </div>

    <!-- 3. Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white"><i class="fa-solid fa-sliders"></i> Qu·∫£n Tr·ªã</h2>
                <button onclick="app.closeModal('settings-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <button onclick="switchSettingsTab('general')" id="tab-general" class="flex-1 py-3 font-semibold text-sm transition-colors border-b-2 border-blue-600 dark:border-neon-green text-blue-600 dark:text-neon-green">Chung</button>
                <button onclick="switchSettingsTab('menu')" id="tab-menu" class="flex-1 py-3 font-semibold text-sm transition-colors border-b-2 border-transparent text-gray-500">Th·ª±c ƒê∆°n</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-white dark:bg-gray-800">
                <!-- Tab: General -->
                <div id="content-general" class="space-y-6">
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
                        <div>
                            <h3 class="font-bold text-gray-900 dark:text-white">Giao di·ªán</h3>
                            <p class="text-sm text-gray-500">Dark/Light Mode</p>
                        </div>
                        <button onclick="app.toggleTheme()" class="bg-gray-300 dark:bg-neon-green/20 border border-gray-400 dark:border-neon-green text-gray-700 dark:text-neon-green px-4 py-2 rounded-lg font-bold">ƒê·ªïi</button>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-gray-900 dark:text-white mb-2">Ch·ªët Ng√†y (L∆∞u & Reset)</h3>
                        <button onclick="app.endDay()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold mb-4">CH·ªêT NG√ÄY</button>
                        <h4 class="font-bold text-gray-900 dark:text-white mb-2 text-sm">L·ªãch s·ª≠ Ch·ªët:</h4>
                        <div id="archive-list" class="max-h-32 overflow-y-auto text-sm text-gray-600 dark:text-gray-400 space-y-1"></div>
                    </div>
                    <button onclick="app.logout()" class="w-full py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">ƒêƒÉng Xu·∫•t</button>
                </div>
                <!-- Tab: Menu -->
                <div id="content-menu" class="hidden space-y-6">
                    <div class="grid grid-cols-4 gap-3">
                        <input type="text" id="new-item-name" placeholder="T√™n m√≥n" class="col-span-2 px-3 py-2 rounded bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">
                        <input type="number" id="new-item-price" placeholder="Gi√°" class="px-3 py-2 rounded bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">
                        <input type="number" id="new-item-stock" placeholder="Kho" class="px-3 py-2 rounded bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">
                        <button onclick="app.addMenuItem()" class="col-span-4 bg-blue-600 dark:bg-neon-green text-white dark:text-black font-bold py-2 rounded">Th√™m M√≥n</button>
                    </div>
                    <table class="w-full text-left text-sm"><tbody id="settings-menu-list"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE SCRIPT: FIREBASE & LOGIC -->
    <script type="module">
        // 1. IMPORT
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, onChildAdded } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyC44jwQPMYFJS-sKj3kLM13q2A4OGPt9Xg",
            authDomain: "winbilliards-33482.firebaseapp.com",
            databaseURL: "https://winbilliards-33482-default-rtdb.firebaseio.com",
            projectId: "winbilliards-33482",
            storageBucket: "winbilliards-33482.firebasestorage.app",
            messagingSenderId: "779828663960",
            appId: "1:779828663960:web:cc68d6253b8f8a2d15c2ed",
            measurementId: "G-Z4GKVK5Y6Z"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);

        // 3. CONSTANTS
        const BLOCK_PRICE = 10000;
        const BLOCK_MINUTES = 15;
        const DEFAULT_MENU = [
            { id: '1', name: 'Sting', price: 15000, stock: 50 },
            { id: '2', name: 'Coca Cola', price: 15000, stock: 50 },
            { id: '3', name: 'N∆∞·ªõc Su·ªëi', price: 10000, stock: 100 },
            { id: '4', name: 'ThƒÉng Long', price: 15000, stock: 20 },
            { id: '5', name: 'Vina', price: 20000, stock: 20 }
        ];

        // Format
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(amount);
        const formatDuration = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return (h > 0 ? `${h}h ` : '') + (m > 0 ? `${m}p ` : '') + `${s}s`;
        };
        const calculateCost = (startTime, currentTime) => {
            if (!startTime) return 0;
            const durationMinutes = (currentTime - startTime) / 1000 / 60;
            if (durationMinutes <= 0) return 0;
            return Math.ceil(durationMinutes / BLOCK_MINUTES) * BLOCK_PRICE;
        };

        // 4. APP LOGIC
        const app = {
            data: {
                tables: [],
                history: [],
                archives: [],
                menu: [],
                theme: 'dark',
                isLoggedIn: false,
                currentTime: Date.now()
            },
            selectedTableId: null,
            chartInstance: null,

            init: function() {
                const isLogged = localStorage.getItem('isLoggedIn') === 'true';
                if (isLogged) {
                    this.data.isLoggedIn = true;
                    this.showDashboard();
                } else {
                    this.showLogin();
                }
                this.setupEventListeners();
                setInterval(() => {
                    this.data.currentTime = Date.now();
                    if(this.data.isLoggedIn) this.renderTables();
                }, 1000);
            },

            // --- SYNC DATA ---
            connectFirebase: function() {
                document.getElementById('loading-tables').classList.remove('hidden');
                document.getElementById('table-grid').classList.add('hidden');

                // 1. Tables: Read & Check exists
                onValue(ref(db, 'tables'), (snapshot) => {
                    const val = snapshot.val();
                    if (!val) {
                        // DB EMPTY -> Create Defaults (Safety Check)
                        const defaults = Array.from({ length: 6 }, (_, i) => ({
                            id: i + 1, status: 'idle', startTime: null, items: [], savedSessions: []
                        }));
                        this.data.tables = defaults;
                        set(ref(db, 'tables'), defaults);
                    } else {
                        // DB EXISTS -> Use it
                        this.data.tables = Array.isArray(val) ? val : Object.values(val);
                        // Normalize arrays
                        this.data.tables = this.data.tables.map(t => ({
                            ...t, 
                            items: t.items || [], 
                            savedSessions: t.savedSessions || []
                        }));
                    }
                    this.renderTables();
                    document.getElementById('loading-tables').classList.add('hidden');
                    document.getElementById('table-grid').classList.remove('hidden');
                });

                // 2. Menu
                onValue(ref(db, 'menu'), (snapshot) => {
                    const val = snapshot.val();
                    if (!val) {
                        this.data.menu = DEFAULT_MENU;
                        set(ref(db, 'menu'), DEFAULT_MENU);
                    } else {
                        this.data.menu = Array.isArray(val) ? val : Object.values(val);
                    }
                    this.renderSettingsMenu();
                });

                // 3. History
                onValue(ref(db, 'history'), (snapshot) => {
                    const val = snapshot.val();
                    this.data.history = val ? Object.values(val) : [];
                    this.renderHistory();
                });

                // 4. Archives
                onValue(ref(db, 'archives'), (snapshot) => {
                    const val = snapshot.val();
                    this.data.archives = val ? Object.values(val) : [];
                    this.renderArchives();
                });
                
                // 5. Notifications
                onChildAdded(ref(db, 'history'), (snapshot) => {
                    const val = snapshot.val();
                    if(!val) return;
                    const timeDiff = Date.now() - val.endTime;
                    if (timeDiff < 30000) {
                        this.showNotification(`üîî B√†n ${val.tableId} v·ª´a thanh to√°n`, `T·ªïng: ${formatCurrency(val.totalAmount)}`);
                        const audio = document.getElementById('notification-sound');
                        audio.play().catch(e => console.log('Interact needed'));
                    }
                });
            },

            // --- ACTIONS ---
            startTable: function(id) {
                const idx = this.data.tables.findIndex(t => t.id === id);
                if (idx > -1) {
                    update(ref(db, `tables/${idx}`), {
                        status: 'active',
                        startTime: Date.now(),
                        items: [],
                        savedSessions: []
                    });
                }
            },

            stopTableRequest: function(id) {
                this.selectedTableId = id;
                this.renderCheckoutModal();
                document.getElementById('checkout-modal').classList.remove('hidden');
            },

            confirmCheckout: function() {
                const table = this.data.tables.find(t => t.id === this.selectedTableId);
                const tableIdx = this.data.tables.findIndex(t => t.id === this.selectedTableId);
                if (!table || tableIdx === -1) return;

                const endTime = Date.now();
                const currentAmount = calculateCost(table.startTime, endTime);
                const savedAmount = table.savedSessions.reduce((sum, s) => sum + s.amount, 0);
                const serviceAmount = table.items.reduce((sum, item) => {
                    const m = this.data.menu.find(x => x.id === item.id);
                    return sum + (m ? m.price * item.count : 0);
                }, 0);
                const totalAmount = currentAmount + savedAmount + serviceAmount;

                const newRecord = {
                    id: Date.now().toString(),
                    tableId: table.id,
                    startTime: table.savedSessions.length > 0 ? table.savedSessions[0].startTime : table.startTime,
                    endTime: endTime,
                    totalAmount: totalAmount
                };

                push(ref(db, 'history'), newRecord);
                update(ref(db, `tables/${tableIdx}`), {
                    status: 'idle',
                    startTime: null,
                    items: [],
                    savedSessions: []
                });
                this.closeModal('checkout-modal');
            },

            splitSession: function(id) {
                const tableIdx = this.data.tables.findIndex(t => t.id === id);
                const table = this.data.tables[tableIdx];
                if (tableIdx > -1 && table.status === 'active') {
                    const now = Date.now();
                    const cost = calculateCost(table.startTime, now);
                    const newSession = { startTime: table.startTime, endTime: now, amount: cost };
                    const updatedSessions = [...(table.savedSessions || []), newSession];
                    
                    update(ref(db, `tables/${tableIdx}`), {
                        savedSessions: updatedSessions,
                        startTime: now
                    });
                }
            },

            // --- INVENTORY & ORDER (INSTANT FEEDBACK FIX) ---
            orderRequest: function(id) {
                this.selectedTableId = id;
                this.renderServiceModal();
                document.getElementById('service-modal').classList.remove('hidden');
            },

            updateOrder: function(itemId, change) {
                // 1. Get current local state
                const tableIdx = this.data.tables.findIndex(t => t.id === this.selectedTableId);
                const table = this.data.tables[tableIdx];
                const menuIdx = this.data.menu.findIndex(m => m.id === itemId);
                const menuItem = this.data.menu[menuIdx];

                if (!table || !menuItem) return;

                // 2. Stock check
                if (change > 0 && menuItem.stock <= 0) {
                    alert('H·∫øt h√†ng trong kho!');
                    return;
                }

                // 3. Update Table Items array locally
                let items = [...(table.items || [])];
                const itemInTableIdx = items.findIndex(i => i.id === itemId);
                let currentQty = itemInTableIdx > -1 ? items[itemInTableIdx].count : 0;
                let newQty = currentQty + change;
                
                if (newQty < 0) newQty = 0;

                // 4. INSTANT UI UPDATE (Direct DOM Manipulation)
                const qtySpan = document.getElementById(`qty-${itemId}`);
                if (qtySpan) {
                    qtySpan.innerText = newQty;
                    // Add simple animation effect
                    qtySpan.classList.add('scale-125', 'text-neon-green');
                    setTimeout(() => qtySpan.classList.remove('scale-125', 'text-neon-green'), 150);
                }
                
                // Toggle Minus button state
                const minusBtn = document.getElementById(`btn-minus-${itemId}`);
                if (minusBtn) minusBtn.disabled = (newQty === 0);

                // 5. Update Internal Data
                if (itemInTableIdx > -1) {
                    items[itemInTableIdx].count = newQty;
                    if (newQty === 0) items.splice(itemInTableIdx, 1);
                } else if (change > 0) {
                    items.push({ id: itemId, count: newQty });
                }

                // 6. Sync to Firebase (Background)
                const updates = {};
                updates[`tables/${tableIdx}/items`] = items;
                updates[`menu/${menuIdx}/stock`] = menuItem.stock - change;

                update(ref(db), updates).catch(err => console.error("Sync error", err));
            },

            // --- MENU MANAGEMENT ---
            updateStock: function(id, value) {
                const val = parseInt(value);
                if (isNaN(val) || val < 0) {
                    alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!');
                    this.renderSettingsMenu(); // Reset UI
                    return;
                }
                
                const idx = this.data.menu.findIndex(m => m.id === id);
                if (idx > -1) {
                    // Optimistic update
                    this.data.menu[idx].stock = val;
                    
                    // Firebase update
                    update(ref(db, `menu/${idx}`), { stock: val })
                        .then(() => {
                            this.showNotification('Kho h√†ng', 'ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng!');
                            this.renderSettingsMenu();
                        })
                        .catch(err => {
                            console.error(err);
                            alert('L·ªói c·∫≠p nh·∫≠t Firebase');
                        });
                }
            },

            addMenuItem: function() {
                const name = document.getElementById('new-item-name').value;
                const price = parseInt(document.getElementById('new-item-price').value);
                const stock = parseInt(document.getElementById('new-item-stock').value);

                if (name && price && stock >= 0) {
                    const newItem = { id: 'item_' + Date.now(), name, price, stock };
                    const newMenu = [...this.data.menu, newItem];
                    set(ref(db, 'menu'), newMenu);
                    
                    document.getElementById('new-item-name').value = '';
                    document.getElementById('new-item-price').value = '';
                    document.getElementById('new-item-stock').value = '';
                }
            },
            
            deleteMenuItem: function(id) {
                if(confirm('X√≥a m√≥n n√†y?')) {
                    const newMenu = this.data.menu.filter(m => m.id !== id);
                    set(ref(db, 'menu'), newMenu);
                }
            },

            // --- ADMIN ---
            endDay: function() {
                if(confirm('Ch·ªët ng√†y s·∫Ω l∆∞u doanh thu v√† x√≥a l·ªãch s·ª≠ h√¥m nay?')) {
                    const total = this.data.history.reduce((sum, h) => sum + h.totalAmount, 0);
                    const archive = {
                        id: Date.now().toString(),
                        timestamp: Date.now(),
                        totalRevenue: total
                    };
                    push(ref(db, 'archives'), archive);
                    set(ref(db, 'history'), null);
                    alert('ƒê√£ ch·ªët ng√†y!');
                }
            },

            // --- UI RENDERERS ---
            renderTables: function() {
                const container = document.getElementById('table-grid');
                if(!container) return;

                const html = this.data.tables.map(table => {
                    const isActive = table.status === 'active';
                    let currentCost = 0, durationText = '--:--', savedCost = 0, serviceCost = 0;

                    if (isActive) {
                        currentCost = calculateCost(table.startTime, this.data.currentTime);
                        durationText = formatDuration(Math.floor((this.data.currentTime - table.startTime) / 1000));
                    }
                    
                    savedCost = (table.savedSessions || []).reduce((sum, s) => sum + s.amount, 0);
                    serviceCost = (table.items || []).reduce((sum, item) => {
                        const m = this.data.menu.find(x => x.id === item.id);
                        return sum + (m ? m.price * item.count : 0);
                    }, 0);
                    const total = currentCost + savedCost + serviceCost;

                    return `
                    <div class="glass-panel border ${isActive ? 'border-green-500 dark:border-neon-green glow-active' : 'border-gray-200 dark:border-gray-700'} rounded-xl overflow-hidden relative">
                        <div class="p-4 flex justify-between items-center ${isActive ? 'bg-green-100 dark:bg-neon-green/10' : 'bg-gray-100 dark:bg-gray-800/50'}">
                            <div>
                                <h3 class="text-2xl font-display font-bold text-gray-900 dark:text-white">B√ÄN ${table.id}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="w-2 h-2 rounded-full ${isActive ? 'bg-green-500 dark:bg-neon-green animate-pulse' : 'bg-gray-400'}"></div>
                                    <span class="text-xs font-bold uppercase ${isActive ? 'text-green-600 dark:text-neon-green' : 'text-gray-500'}">${isActive ? 'ƒêANG CH∆†I' : 'TR·ªêNG'}</span>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-lg border flex items-center justify-center ${isActive ? 'border-green-300 dark:border-neon-green/50 text-green-600 dark:text-neon-green' : 'border-gray-300 dark:border-gray-600 text-gray-400'}">
                                <i class="fa-solid fa-clock text-lg"></i>
                            </div>
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-gray-50 dark:bg-gray-900/60 p-2 rounded border border-gray-200 dark:border-gray-700">
                                    <span class="text-[10px] uppercase text-gray-500 font-bold">Gi·ªù ch∆°i</span>
                                    <div class="text-gray-900 dark:text-white font-mono font-bold text-lg">${formatCurrency(currentCost)}</div>
                                    <div class="text-blue-600 dark:text-neon-blue text-xs font-mono">${durationText}</div>
                                </div>
                                <div class="p-2 rounded border ${savedCost>0 ? 'bg-purple-50 dark:bg-neon-purple/10 border-purple-200 dark:border-neon-purple/30' : 'bg-gray-50 dark:bg-gray-900/60 border-gray-200 dark:border-gray-700'}">
                                    <span class="text-[10px] uppercase font-bold ${savedCost>0 ? 'text-purple-600 dark:text-neon-purple' : 'text-gray-500'}">ƒê√£ ch·ªët</span>
                                    <div class="font-mono font-bold text-lg ${savedCost>0 ? 'text-gray-900 dark:text-white' : 'text-gray-500'}">${formatCurrency(savedCost)}</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t border-gray-200 dark:border-gray-700/50 pt-2">
                                <span class="text-gray-500 dark:text-gray-400">D·ªãch v·ª•</span>
                                <span class="font-bold text-gray-900 dark:text-white">${formatCurrency(serviceCost)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs uppercase font-bold text-gray-500">T·ªïng</span>
                                <span class="text-2xl font-display font-bold ${isActive ? 'text-yellow-600 dark:text-gold' : 'text-gray-400'}">${formatCurrency(total)}</span>
                            </div>
                        </div>
                        <div class="p-4 pt-0 grid grid-cols-4 gap-2">
                            <button onclick="app.orderRequest(${table.id})" ${!isActive?'disabled':''} class="col-span-1 py-3 rounded border flex justify-center items-center ${isActive?'bg-white dark:bg-gray-800 text-blue-600 dark:text-neon-blue border-gray-300 dark:border-gray-600':'bg-gray-200 dark:bg-gray-900 text-gray-400 cursor-not-allowed'}"><i class="fa-solid fa-utensils"></i></button>
                            <button onclick="app.splitSession(${table.id})" ${!isActive?'disabled':''} class="col-span-1 py-3 rounded border flex justify-center items-center ${isActive?'bg-white dark:bg-gray-800 text-purple-600 dark:text-neon-purple border-gray-300 dark:border-gray-600':'bg-gray-200 dark:bg-gray-900 text-gray-400 cursor-not-allowed'}"><i class="fa-solid fa-scissors"></i></button>
                            <button onclick="${isActive ? `app.stopTableRequest(${table.id})` : `app.startTable(${table.id})`}" class="col-span-2 py-3 rounded font-bold uppercase text-sm flex items-center justify-center gap-2 ${isActive ? 'bg-red-50 dark:bg-neon-red/10 text-red-600 dark:text-neon-red border border-red-200 dark:border-neon-red/50 hover:bg-red-500 hover:text-white' : 'bg-green-500 dark:bg-neon-green text-white dark:text-black hover:bg-green-400'}">
                                ${isActive ? '<i class="fa-solid fa-stop"></i> Thanh to√°n' : '<i class="fa-solid fa-play"></i> M·ªü b√†n'}
                            </button>
                        </div>
                    </div>`;
                }).join('');
                container.innerHTML = html;
            },

            renderServiceModal: function() {
                const table = this.data.tables.find(t => t.id === this.selectedTableId);
                if (!table) return;
                
                document.getElementById('service-modal-table-id').innerText = `(B√†n ${table.id})`;
                const container = document.getElementById('menu-grid');
                
                container.innerHTML = this.data.menu.map(item => {
                    const qty = (table.items || []).find(i => i.id === item.id)?.count || 0;
                    return `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white">${item.name}</h4>
                            <p class="text-blue-600 dark:text-gold font-mono text-sm font-bold">${formatCurrency(item.price)}</p>
                            <p class="text-xs text-gray-500">Kho: ${item.stock}</p>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                            <!-- ADDED ID to Button Minus -->
                            <button id="btn-minus-${item.id}" onclick="app.updateOrder('${item.id}', -1)" ${qty===0?'disabled':''} class="w-8 h-8 flex justify-center items-center rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white hover:bg-red-500 hover:text-white disabled:opacity-50 transition-colors"><i class="fa-solid fa-minus text-xs"></i></button>
                            
                            <!-- ADDED ID to QTY Span -->
                            <span id="qty-${item.id}" class="w-8 text-center font-bold text-gray-800 dark:text-white transition-all duration-150">${qty}</span>
                            
                            <button onclick="app.updateOrder('${item.id}', 1)" ${item.stock<=0?'disabled':''} class="w-8 h-8 flex justify-center items-center rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white hover:bg-green-500 hover:text-white disabled:opacity-50 transition-colors"><i class="fa-solid fa-plus text-xs"></i></button>
                        </div>
                    </div>`;
                }).join('');
            },

            renderCheckoutModal: function() {
                const table = this.data.tables.find(t => t.id === this.selectedTableId);
                if (!table) return;

                const now = Date.now();
                const currentCost = calculateCost(table.startTime, now);
                const savedCost = (table.savedSessions || []).reduce((sum, s) => sum + s.amount, 0);
                const serviceCost = (table.items || []).reduce((sum, item) => {
                    const m = this.data.menu.find(x => x.id === item.id);
                    return sum + (m ? m.price * item.count : 0);
                }, 0);
                const total = currentCost + savedCost + serviceCost;

                let html = `
                    <div class="text-center mb-4"><div class="inline-block px-4 py-1 rounded-full bg-green-100 dark:bg-neon-green/10 text-green-700 dark:text-neon-green border border-green-200 dark:border-neon-green/30 font-bold mb-1">B√ÄN ${table.id}</div></div>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between text-gray-700 dark:text-gray-300"><span>Ti·ªÅn gi·ªù:</span><span class="font-bold text-white">${formatCurrency(currentCost)}</span></div>
                        <div class="flex justify-between text-gray-700 dark:text-gray-300"><span>ƒê√£ ch·ªët:</span><span class="font-bold text-purple-400">${formatCurrency(savedCost)}</span></div>
                        <div class="flex justify-between text-gray-700 dark:text-gray-300"><span>D·ªãch v·ª•:</span><span class="font-bold text-blue-400">${formatCurrency(serviceCost)}</span></div>
                        <div class="border-t border-gray-600 pt-2 mt-2 flex justify-between text-lg"><span class="font-bold text-white">T·ªîNG</span><span class="font-bold text-yellow-500 text-2xl">${formatCurrency(total)}</span></div>
                    </div>`;
                document.getElementById('checkout-content').innerHTML = html;
            },

            renderSettingsMenu: function() {
                const tbody = document.getElementById('settings-menu-list');
                tbody.innerHTML = this.data.menu.map(item => `
                    <tr class="border-b border-gray-700">
                        <td class="p-3 text-white">${item.name}</td>
                        <td class="p-3 text-right text-green-400">${formatCurrency(item.price)}</td>
                        <td class="p-3 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <button onclick="app.updateStock('${item.id}', ${item.stock - 1})" class="w-8 h-8 bg-gray-700 rounded hover:bg-red-500 text-white font-bold transition-colors">-</button>
                                <input type="number" value="${item.stock}" 
                                    onchange="app.updateStock('${item.id}', this.value)"
                                    class="w-16 text-center bg-gray-800 border border-gray-600 rounded text-white text-sm focus:border-neon-green outline-none py-1">
                                <button onclick="app.updateStock('${item.id}', ${item.stock + 1})" class="w-8 h-8 bg-gray-700 rounded hover:bg-green-500 text-white font-bold transition-colors">+</button>
                            </div>
                        </td>
                        <td class="p-3 text-center"><button onclick="app.deleteMenuItem('${item.id}')" class="text-red-500 hover:text-red-400 transition-colors"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `).join('');
            },

            renderHistory: function() {
                const total = this.data.history.reduce((sum, h) => sum + h.totalAmount, 0);
                document.getElementById('total-revenue-display').innerText = formatCurrency(total);
                document.getElementById('history-count').innerText = `${this.data.history.length} GD`;
                
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = [...this.data.history].sort((a,b)=>b.endTime-a.endTime).map(h => `
                    <tr class="hover:bg-gray-800/50">
                        <td class="p-4"><span class="bg-gray-700 text-white px-2 py-1 rounded text-xs font-bold">B√†n ${h.tableId}</span></td>
                        <td class="p-4 text-gray-400 text-sm">${new Date(h.endTime).toLocaleTimeString()}</td>
                        <td class="p-4 text-right text-gold font-bold">${formatCurrency(h.totalAmount)}</td>
                    </tr>
                `).join('');
                this.renderChart();
            },

            renderArchives: function() {
                const list = document.getElementById('archive-list');
                list.innerHTML = this.data.archives.map(a => `
                    <div class="flex justify-between p-2 bg-gray-700 rounded mb-1"><span>${new Date(a.timestamp).toLocaleDateString()}</span><span class="font-bold text-gold">${formatCurrency(a.totalRevenue)}</span></div>
                `).join('');
            },

            renderChart: function() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                if (this.chartInstance) this.chartInstance.destroy();
                const chartData = Array.from({length:6},(_,i)=>{
                    const tid = i+1;
                    return this.data.history.filter(h=>h.tableId===tid).reduce((s,h)=>s+h.totalAmount,0);
                });
                this.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['B1','B2','B3','B4','B5','B6'],
                        datasets: [{label:'Doanh thu',data:chartData,backgroundColor:'rgba(57,255,20,0.5)',borderColor:'#39ff14',borderWidth:1}]
                    },
                    options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.1)'}},x:{grid:{display:false}}}}
                });
            },

            // --- HELPERS ---
            showNotification: function(title, message) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast bg-gray-800 border-l-4 border-neon-green text-white p-4 rounded shadow-2xl flex items-center gap-4 animate-slide-in';
                toast.innerHTML = `
                    <div class="bg-green-500/20 p-2 rounded-full text-green-400"><i class="fa-solid fa-bell"></i></div>
                    <div><h4 class="font-bold">${title}</h4><p class="text-sm text-gray-300">${message}</p></div>
                `;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            },
            
            showLogin: function() {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            },
            showDashboard: function() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                this.connectFirebase(); // Connect Realtime DB
            },
            closeModal: function(id) { document.getElementById(id).classList.add('hidden'); },
            toggleTheme: function() { 
                document.documentElement.classList.toggle('dark'); 
                const isDark = document.documentElement.classList.contains('dark');
                this.data.theme = isDark ? 'dark' : 'light';
            },
            logout: function() {
                localStorage.removeItem('isLoggedIn');
                location.reload();
            },
            setupEventListeners: function() {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const u = document.getElementById('username').value;
                    const p = document.getElementById('password').value;
                    if(u === 'admin' && p === '123456') {
                        localStorage.setItem('isLoggedIn', 'true');
                        this.data.isLoggedIn = true;
                        this.showDashboard();
                    } else {
                        document.getElementById('login-error').classList.remove('hidden');
                    }
                });
                document.getElementById('settings-btn').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('hidden'));
            }
        };

        // EXPOSE TO WINDOW FOR HTML ONCLICK
        window.app = app;
        window.switchSettingsTab = (tab) => {
            document.getElementById('content-general').classList.toggle('hidden', tab!=='general');
            document.getElementById('content-menu').classList.toggle('hidden', tab!=='menu');
            document.getElementById('tab-general').classList.toggle('border-blue-600', tab==='general');
            document.getElementById('tab-general').classList.toggle('text-blue-600', tab==='general');
            document.getElementById('tab-menu').classList.toggle('border-blue-600', tab==='menu');
            document.getElementById('tab-menu').classList.toggle('text-blue-600', tab==='menu');
        };

        // RUN
        app.init();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
